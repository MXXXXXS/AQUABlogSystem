<template>
  <div class="whole" :style="{border: '2px solid ' + themeColor}">
    <div class="bar">
      <div class="tools" :style="{top: offset}">
        <div id="addImg" class="addImg tool" @click="showOption('addImg')">
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            width="200"
            height="200"
          >
            <path
              d="M918.691833 149.924149H108.740166c-54.370083 0-98.44417 44.254719-98.44417 98.44417V803.810196c0 54.370083 44.254719 98.44417 98.44417 98.44417h809.951667c54.370083 0 98.44417-44.254719 98.44417-98.44417V248.368319c0-54.189451-44.074087-98.44417-98.44417-98.44417zM108.740166 214.590228h809.951667c18.605045 0 33.778091 15.173046 33.778091 33.778091v444.534133c-68.278709-106.391956-120.842477-174.851297-175.393191-184.244135-20.050097-3.431999-39.016405 1.445052-54.911977 14.089258l-2.890104 2.709472c-35.765038 36.487564-57.982713 71.530076-77.490916 102.418063-23.662727 37.390721-40.642089 64.304816-71.710707 77.310284-0.361263 0-13.1861-0.541895-42.809667-38.835773-23.843359-30.526724-48.951138-72.433233-75.503969-116.687952-30.887987-51.479979-62.859764-104.585641-94.83154-142.87952-35.945669-42.809667-73.155759-45.699771-98.082907-40.642089-73.697654 15.173046-137.641207 125.358264-183.70224 234.459693v-352.231434c-0.180632-18.605045 14.992415-33.778091 33.59746-33.778091z m809.951667 623.178691H108.740166c-18.605045 0-33.778091-15.173046-33.778092-33.778092v-10.83789C136.015523 590.303757 216.757806 441.282766 271.850415 429.902981c4.696419-0.903158 16.979361-3.431999 35.584406 18.785677 28.720409 34.319986 59.427765 85.25807 89.051332 134.570471 59.789028 99.527959 112.352796 187.31487 172.683718 187.31487 8.489681 0 16.979361-1.806315 25.830305-5.418945 49.854295-20.772623 74.962074-60.330923 101.514906-102.418063 17.521256-27.63662 37.21009-58.885871 67.19492-89.95449 0.722526-0.361263 1.445052-0.361263 2.528841-0.180631 38.835774 6.683366 116.326689 130.054683 162.568354 203.932969 7.767155 12.282942 15.173046 24.204622 22.578938 35.765038-3.61263 14.45052-16.979361 25.469042-32.694302 25.469042z"
              p-id="23008"
              fill="#ffffff"
            ></path>
            <path
              d="M764.071265 471.086964c61.053449 0 110.546481-49.673664 110.546481-110.546481s-49.673664-110.546481-110.546481-110.546481-110.546481 49.673664-110.546481 110.546481 49.673664 110.546481 110.546481 110.546481z m0-156.426883c25.288411 0 45.880402 20.591992 45.880402 45.880402 0 25.288411-20.591992 45.880402-45.880402 45.880403s-45.880402-20.591992-45.880402-45.880403c0-25.288411 20.591992-45.880402 45.880402-45.880402z"
              p-id="23009"
              fill="#ffffff"
            ></path>
          </svg>
        </div>
        <div id="addLink" class="tool" @click="showOption('addLink')">
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            width="200"
            height="200"
          >
            <path
              d="M614.4 384h-6.4c-19.2 0-38.4 6.4-51.2 19.2 12.8 19.2 19.2 44.8 19.2 76.8C576 569.6 505.6 640 416 640h-192C134.4 640 64 569.6 64 480S134.4 320 224 320h147.2c12.8-25.6 32-44.8 57.6-64H224C102.4 256 0 358.4 0 480S102.4 704 224 704h192C537.6 704 640 601.6 640 480c0-32-6.4-64-25.6-96z"
              p-id="12799"
              fill="#ffffff"
            ></path>
            <path
              d="M800 256h-192C486.4 256 384 358.4 384 480c0 32 6.4 64 25.6 96h6.4c19.2 0 38.4-6.4 51.2-19.2C454.4 537.6 448 512 448 480 448 390.4 518.4 320 608 320h192C889.6 320 960 390.4 960 480S889.6 640 800 640h-147.2c-12.8 25.6-32 44.8-57.6 64h204.8c121.6 0 224-102.4 224-224S921.6 256 800 256z"
              p-id="12800"
              fill="#ffffff"
            ></path>
          </svg>
        </div>
        <div id="addEmo" class="tool" @click="showOption('addEmo')">
          <svg
            viewBox="0 0 1044 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            width="203.90625"
            height="200"
          >
            <path
              d="M515.204746 1024C377.571561 1024 248.168301 970.752 150.869338 874.116741 53.551412 777.367704-0.018958 648.798815 5.0e-06 512 5.0e-06 375.220148 53.608301 246.632296 150.94519 149.921185 248.244153 53.248 377.647412 0 515.299561 0 652.989635 0 782.373931 53.248 879.71082 149.921185 1080.623412 349.601185 1080.604449 674.417778 879.71082 874.021926 782.354968 970.714074 652.89482 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024 515.204746 1024ZM515.299561 66.730667C395.567412 66.730667 283.060153 113.019259 198.409487 197.101037 113.75882 281.163852 67.147857 393.02637 67.147857 512 67.128894 630.992593 113.720894 742.836148 198.333635 826.936889 282.965338 910.980741 395.510524 957.326222 515.204746 957.326222 634.955857 957.326222 747.557931 910.942815 832.227561 826.842074 1006.933338 653.255111 1006.933338 370.744889 832.227561 197.101037 747.576894 113.019259 635.031709 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667 515.299561 66.730667ZM332.174227 651.738074C332.174227 651.738074 392.552301 747.633778 515.185783 747.633778 637.819264 747.633778 718.24119 651.738074 718.24119 651.738074 718.24119 651.738074 763.828153 651.58637 763.80919 699.676444 763.80919 699.676444 684.771561 811.557926 515.185783 811.557926 345.600005 811.557926 290.39882 699.676444 290.39882 699.676444 290.39882 699.676444 288.730079 651.738074 332.174227 651.738074 332.174227 651.738074 332.174227 651.738074 332.174227 651.738074 332.174227 651.738074 332.174227 651.738074 332.174227 651.738074ZM365.454227 347.363556C330.714079 347.363556 302.345487 375.447704 302.345487 410.074074 302.345487 444.662519 330.695116 472.746667 365.454227 472.746667 400.365042 472.746667 428.562968 444.662519 428.562968 410.074074 428.562968 375.447704 400.365042 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556 365.454227 347.363556ZM688.791709 347.363556C653.994672 347.363556 625.720894 375.447704 625.720894 410.074074 625.720894 444.662519 653.994672 472.746667 688.791709 472.746667 723.664598 472.746667 751.900449 444.662519 751.900449 410.074074 751.900449 375.447704 723.664598 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556 688.791709 347.363556Z"
              p-id="1412"
              fill="#ffffff"
            ></path>
          </svg>
        </div>
        <div id="preview" class="tool" @click="showOption('preview')">
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            width="200"
            height="200"
          >
            <path
              d="M921.3 874L738.1 690.8c51.3-62.6 82.1-142.5 82.1-229.6 0-200.1-162.8-363-363-363-200.1 0-363 162.8-363 363s162.8 363 363 363c87 0 167-30.8 229.6-82.1L870 925.3c7.1 7.1 16.4 10.6 25.7 10.6s18.6-3.5 25.7-10.6c14.1-14.2 14.1-37.2-0.1-51.3zM166.8 461.2c0-160.1 130.3-290.4 290.4-290.4s290.4 130.3 290.4 290.4-130.3 290.4-290.4 290.4-290.4-130.3-290.4-290.4z"
              p-id="23546"
              fill="#ffffff"
            ></path>
          </svg>
        </div>
        <div id="upload" class="tool" @click="showOption('upload')">
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            width="200"
            height="200"
          >
            <path
              d="M1009.319087 5.274069a31.995081 31.995081 0 0 0-35.194589 0l-959.852422 639.901615a31.995081 31.995081 0 0 0 5.759114 56.311342l250.201532 100.144603 117.741897 206.04832A31.995081 31.995081 0 0 0 416.13029 1023.99744a31.995081 31.995081 0 0 0 27.515769-15.677589l66.549768-110.70298 310.032333 124.140914A31.995081 31.995081 0 0 0 832.06634 1023.99744a31.995081 31.995081 0 0 0 31.99508-26.875867l159.975404-959.852423a31.995081 31.995081 0 0 0-14.717737-31.995081zM100.658794 665.012634L841.984815 170.688637l-539.117111 575.911453a63.990162 63.990162 0 0 0-8.638672-5.119213z m225.565319 105.263816L931.890992 121.096261 416.13029 926.092493z m479.926211 177.252747l-273.237989-109.423176a63.990162 63.990162 0 0 0-19.83695-3.839409L934.450598 182.206866z"
              fill="#ffffff"
            ></path>
          </svg>
        </div>
      </div>
      <div class="option" :style="{top: offset}">
        <div id="back" @click="showTools">
          <svg
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="4982"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            width="200"
            height="200"
          >
            <path
              d="M512 64C264.64 64 64 264.64 64 512c0 247.424 200.64 448 448 448 247.488 0 448-200.576 448-448C960 264.64 759.488 64 512 64zM512 896.768c-212.48 0-384.768-172.224-384.768-384.768S299.52 127.232 512 127.232 896.64 299.52 896.64 512 724.48 896.768 512 896.768zM768 512.32c0 18.112-14.72 32.832-32.896 32.832L368.128 544.832l153.664 153.664c12.8 12.8 12.8 33.536 0 46.464-6.464 6.4-14.784 9.6-23.232 9.6-8.384 0-16.832-3.264-23.168-9.6L265.6 535.232C265.472 535.04 265.408 534.848 265.344 534.72c-2.88-2.944-5.184-6.4-6.784-10.176C257.216 521.152 256.64 517.632 256.448 514.048 256.448 513.344 256 512.768 256 512c0-0.512 0.32-0.896 0.32-1.344C256.448 506.816 257.152 503.04 258.56 499.456 259.904 496.192 262.016 493.44 264.32 490.816c0.512-0.64 0.704-1.408 1.344-2.048L475.392 279.04c12.8-12.8 33.6-12.8 46.464 0s12.8 33.6 0 46.464l-153.664 153.6 366.976 0C753.28 479.104 768 494.208 768 512.32z"
              p-id="4983"
              fill="#2c2c2c"
            ></path>
          </svg>
        </div>
        <div class="func">
          <div class="imgOpt">
            <input type="url" id="imgURL">
            <div class="add" @click="$el.querySelector('#choseImg').click()">
              <input
                type="file"
                id="choseImg"
                accept=".jpg, .jpeg, .png, .gif, .bmp"
                @input="imgChosen"
              >
              <svg
                t="1556334873043"
                class="icon"
                style
                viewBox="0 0 1024 1024"
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                width="200"
                height="200"
              >
                <path
                  d="M912.486 452.041v0h-687.071c-25.518 0-47.091 16.669-54.521 39.729v0l-59.946 184.682v-510.65h286.299c0 63.238 51.229 114.467 114.471 114.467v0h286.236v114.469h57.229v-114.469c0-31.588-25.639-57.236-57.229-57.236h-286.304c-31.586 0-57.234-25.645-57.234-57.231v0c0-31.589-25.58-57.234-57.234-57.234v0h-286.236c-31.587 0-57.234 25.646-57.234 57.234v686.941c0 31.589 25.646 57.229 57.234 57.229h686.943c25.518 0 47.091-16.663 54.521-39.729h0.063l117.116-360.974c0.001-31.587-25.516-57.169-57.106-57.234v0zM800.864 852.747h-689.914l111.498-343.471h689.909l-111.494 343.471z"
                  p-id="7094"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="comment" :style="{borderColor: themeColor}">
      <textarea class="md" v-model="md"></textarea>
      <div class="mdPre" v-html="mdPre"></div>
    </div>
    <div class="wordsLimit">---/140</div>
  </div>
</template>
<script>
import MarkdownIt from "markdown-it";
const md = new MarkdownIt();
import { wrap, addImgs } from "../utils/clientSide.js";
import Randexp from "randexp";
import resizeImg from "../utils/resizeImg.js";

class Debounce {
  constructor() {
    this.time = new Date().getTime();
  }
  debounce(fn, ms) {
    window.clearTimeout(this.tId);
    this.tId = window.setTimeout(() => {
      fn();
      window.clearTimeout();
    }, ms);
  }
}

const debounce = new Debounce();

export default {
  props: ["themeColor"],
  data() {
    return {
      offset: "0",
      imgs: {}, //{name: [base64, false],...}
      md: ""
    };
  },
  computed: {
    mdPre: function() {
      let srcmd = this.md;
      const imgReg = /!\[Alt .*\]\(([\w\d]{2}__.*)\)/g;
      let result;
      while ((result = imgReg.exec(srcmd))) {
        const prefix__name = result[1];
        if (this.imgs[prefix__name]) {
          this.imgs[prefix__name][1] = true //使用中的图片, 置true
          srcmd = srcmd.replace(prefix__name, this.imgs[prefix__name][0]);
        }
      }
      //清理未使用图片, 减小内存占用
      for (const key in this.imgs) {
        if (this.imgs.hasOwnProperty(key)) {
          const element = this.imgs[key];
          if (!element[1])
          this.$delete(this.imgs, key)
          //全部置false, 当下次检验到使用中时再置true
          this.imgs[key][1] = false
        }
      }

      return md.render(srcmd);
    }
  },
  methods: {
    showOption: function(action) {
      this.offset = "-40px";
      // [action]
    },
    showTools: function() {
      this.offset = "0";
    },
    imgChosen: function(e) {
      const prefixReg = /[\w\d]{2}/;
      const prefix = new Randexp(prefixReg).gen();
      if (e.target.files[0]) {
        const image = e.target.files[0];
        resizeImg(image, 40, 40).then(dataurl => {
          this.imgs = Object.assign({}, this.imgs, {
            [prefix + "__" + image.name]: [dataurl, true]
          });
          console.log(image);
          const einput = new Event(`input`);
          const textarea = document.querySelector(`.md`);
          textarea.setRangeText(
            `![Alt ${image.name}](${prefix + "__" + image.name})`
          );
          textarea.dispatchEvent(einput);
        });
      }
    },
    update(e) {
      debounce.debounce(() => {
        this.md = e.target.value;
      }, 100);
    }
  }
};
</script>
<style scoped>
.whole {
  max-width: 500px;
  min-width: 200px;
  width: 70%;
  /* height: 200px; */
  max-height: 500px;
  border-radius: 10px;
  overflow: hidden;
}

.bar {
  overflow: hidden;
  width: 100%;
  height: 40px;
  position: relative;
}

.tools {
  width: 100%;
  position: relative;
  display: flex;
  justify-content: space-around;
}

.option {
  position: relative;
  display: flex;
}

.func {
  width: 100%;
}

.func input {
  font-size: 30px;
}

.imgOpt {
  display: flex;
}

.tools,
.option {
  transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
}

.tools >>> div {
  width: 40px;
  height: 40px;
}

.tools >>> svg,
.option >>> svg {
  width: 40px;
  height: 40px;
}

#back {
  width: min-content;
}

/* .option {
  height: 40px;
} */

#imgURL {
  width: 100%;
}

#choseImg {
  display: none;
}

.comment {
  height: calc(100% - 64px);
  display: flex;
  border-style: solid;
  border-width: 2px 0;
}

.md {
  width: 100%;
  height: 200px;
  margin: 2px;
  border: none;
  resize: none;
}

.mdPre {
  /* margin: 2px; */
  width: 50%;
  height: 200px;
}

.mdPre >>> img {
  max-width: 40px;
  max-height: 40px;
}

.wordsLimit {
  position: relative;
  width: 70px;
  left: calc(80% - 30px);
}
</style>
